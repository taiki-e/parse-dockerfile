{
  "parser_directives": {
    "syntax": {
      "start": 2,
      "value": {
        "span": {
          "start": 9,
          "end": 42
        },
        "value": "docker/dockerfile-upstream:master"
      }
    },
    "escape": null,
    "check": null
  },
  "instructions": [
    {
      "kind": "ARG",
      "arg": {
        "span": {
          "start": 44,
          "end": 47
        }
      },
      "arguments": {
        "span": {
          "start": 48,
          "end": 63
        },
        "value": "GO_VERSION=1.25"
      }
    },
    {
      "kind": "ARG",
      "arg": {
        "span": {
          "start": 64,
          "end": 67
        }
      },
      "arguments": {
        "span": {
          "start": 68,
          "end": 89
        },
        "value": "DEBIAN_VERSION=trixie"
      }
    },
    {
      "kind": "ARG",
      "arg": {
        "span": {
          "start": 90,
          "end": 93
        }
      },
      "arguments": {
        "span": {
          "start": 94,
          "end": 115
        },
        "value": "PROTOC_VERSION=3.11.4"
      }
    },
    {
      "kind": "ARG",
      "arg": {
        "span": {
          "start": 116,
          "end": 119
        }
      },
      "arguments": {
        "span": {
          "start": 120,
          "end": 186
        },
        "value": "PROTOC_GOOGLEAPIS_VERSION=2af421884dd468d565137215c946ebe4e245ae26"
      }
    },
    {
      "kind": "FROM",
      "from": {
        "span": {
          "start": 296,
          "end": 300
        }
      },
      "options": [],
      "image": {
        "span": {
          "start": 301,
          "end": 339
        },
        "value": "golang:${GO_VERSION}-${DEBIAN_VERSION}"
      },
      "as_": [
        {
          "span": {
            "start": 340,
            "end": 342
          }
        },
        {
          "span": {
            "start": 343,
            "end": 347
          },
          "value": "base"
        }
      ]
    },
    {
      "kind": "RUN",
      "run": {
        "span": {
          "start": 348,
          "end": 351
        }
      },
      "options": [],
      "arguments": {
        "shell": {
          "span": {
            "start": 352,
            "end": 422
          },
          "value": "apt-get update && apt-get --no-install-recommends install -y git unzip"
        }
      },
      "here_docs": []
    },
    {
      "kind": "FROM",
      "from": {
        "span": {
          "start": 424,
          "end": 428
        }
      },
      "options": [],
      "image": {
        "span": {
          "start": 429,
          "end": 433
        },
        "value": "base"
      },
      "as_": [
        {
          "span": {
            "start": 434,
            "end": 436
          }
        },
        {
          "span": {
            "start": 437,
            "end": 443
          },
          "value": "protoc"
        }
      ]
    },
    {
      "kind": "ARG",
      "arg": {
        "span": {
          "start": 444,
          "end": 447
        }
      },
      "arguments": {
        "span": {
          "start": 448,
          "end": 462
        },
        "value": "PROTOC_VERSION"
      }
    },
    {
      "kind": "ARG",
      "arg": {
        "span": {
          "start": 463,
          "end": 466
        }
      },
      "arguments": {
        "span": {
          "start": 467,
          "end": 475
        },
        "value": "TARGETOS"
      }
    },
    {
      "kind": "ARG",
      "arg": {
        "span": {
          "start": 476,
          "end": 479
        }
      },
      "arguments": {
        "span": {
          "start": 480,
          "end": 490
        },
        "value": "TARGETARCH"
      }
    },
    {
      "kind": "RUN",
      "run": {
        "span": {
          "start": 491,
          "end": 494
        }
      },
      "options": [],
      "arguments": {
        "shell": {
          "span": {
            "start": 500,
            "end": 500
          },
          "value": ""
        }
      },
      "here_docs": [
        {
          "span": {
            "start": 501,
            "end": 795
          },
          "expand": true,
          "value": "  set -e\n  arch=$(echo $TARGETARCH | sed -e s/amd64/x86_64/ -e s/arm64/aarch_64/)\n  wget -q https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-${TARGETOS}-${arch}.zip\n  unzip protoc-${PROTOC_VERSION}-${TARGETOS}-${arch}.zip -d /opt/protoc\n"
        }
      ]
    },
    {
      "kind": "FROM",
      "from": {
        "span": {
          "start": 800,
          "end": 804
        }
      },
      "options": [],
      "image": {
        "span": {
          "start": 805,
          "end": 809
        },
        "value": "base"
      },
      "as_": [
        {
          "span": {
            "start": 810,
            "end": 812
          }
        },
        {
          "span": {
            "start": 813,
            "end": 823
          },
          "value": "googleapis"
        }
      ]
    },
    {
      "kind": "ARG",
      "arg": {
        "span": {
          "start": 824,
          "end": 827
        }
      },
      "arguments": {
        "span": {
          "start": 828,
          "end": 853
        },
        "value": "PROTOC_GOOGLEAPIS_VERSION"
      }
    },
    {
      "kind": "RUN",
      "run": {
        "span": {
          "start": 854,
          "end": 857
        }
      },
      "options": [],
      "arguments": {
        "shell": {
          "span": {
            "start": 863,
            "end": 863
          },
          "value": ""
        }
      },
      "here_docs": [
        {
          "span": {
            "start": 864,
            "end": 1125
          },
          "expand": true,
          "value": "  set -e\n  wget -q https://github.com/googleapis/googleapis/archive/${PROTOC_GOOGLEAPIS_VERSION}.zip -O googleapis.zip\n  unzip googleapis.zip '*.proto' -d /opt\n  mkdir -p /opt/googleapis\n  mv /opt/googleapis-${PROTOC_GOOGLEAPIS_VERSION} /opt/googleapis/include\n"
        }
      ]
    },
    {
      "kind": "FROM",
      "from": {
        "span": {
          "start": 1130,
          "end": 1134
        }
      },
      "options": [],
      "image": {
        "span": {
          "start": 1135,
          "end": 1139
        },
        "value": "base"
      },
      "as_": [
        {
          "span": {
            "start": 1140,
            "end": 1142
          }
        },
        {
          "span": {
            "start": 1143,
            "end": 1155
          },
          "value": "gobuild-base"
        }
      ]
    },
    {
      "kind": "WORKDIR",
      "workdir": {
        "span": {
          "start": 1156,
          "end": 1163
        }
      },
      "arguments": {
        "span": {
          "start": 1164,
          "end": 1168
        },
        "value": "/app"
      }
    },
    {
      "kind": "FROM",
      "from": {
        "span": {
          "start": 1170,
          "end": 1174
        }
      },
      "options": [],
      "image": {
        "span": {
          "start": 1175,
          "end": 1187
        },
        "value": "gobuild-base"
      },
      "as_": [
        {
          "span": {
            "start": 1188,
            "end": 1190
          }
        },
        {
          "span": {
            "start": 1191,
            "end": 1201
          },
          "value": "vtprotobuf"
        }
      ]
    },
    {
      "kind": "RUN",
      "run": {
        "span": {
          "start": 1202,
          "end": 1205
        }
      },
      "options": [
        {
          "flag_start": 1206,
          "name": {
            "span": {
              "start": 1208,
              "end": 1213
            },
            "value": "mount"
          },
          "value": {
            "span": {
              "start": 1214,
              "end": 1256
            },
            "value": "type=bind,source=go.mod,target=/app/go.mod"
          }
        },
        {
          "flag_start": 1263,
          "name": {
            "span": {
              "start": 1265,
              "end": 1270
            },
            "value": "mount"
          },
          "value": {
            "span": {
              "start": 1271,
              "end": 1313
            },
            "value": "type=bind,source=go.sum,target=/app/go.sum"
          }
        },
        {
          "flag_start": 1320,
          "name": {
            "span": {
              "start": 1322,
              "end": 1327
            },
            "value": "mount"
          },
          "value": {
            "span": {
              "start": 1328,
              "end": 1358
            },
            "value": "type=cache,target=/root/.cache"
          }
        },
        {
          "flag_start": 1365,
          "name": {
            "span": {
              "start": 1367,
              "end": 1372
            },
            "value": "mount"
          },
          "value": {
            "span": {
              "start": 1373,
              "end": 1402
            },
            "value": "type=cache,target=/go/pkg/mod"
          }
        }
      ],
      "arguments": {
        "shell": {
          "span": {
            "start": 1408,
            "end": 1408
          },
          "value": ""
        }
      },
      "here_docs": [
        {
          "span": {
            "start": 1409,
            "end": 1623
          },
          "expand": true,
          "value": "  set -e\n  mkdir -p /opt/vtprotobuf\n  go mod download github.com/planetscale/vtprotobuf\n  cp -R $(go list -m -f='{{.Dir}}' github.com/planetscale/vtprotobuf)/include /opt/vtprotobuf\n  chmod -R 0755 /opt/vtprotobuf\n"
        }
      ]
    },
    {
      "kind": "FROM",
      "from": {
        "span": {
          "start": 1628,
          "end": 1632
        }
      },
      "options": [],
      "image": {
        "span": {
          "start": 1633,
          "end": 1645
        },
        "value": "gobuild-base"
      },
      "as_": [
        {
          "span": {
            "start": 1646,
            "end": 1648
          }
        },
        {
          "span": {
            "start": 1649,
            "end": 1657
          },
          "value": "vendored"
        }
      ]
    },
    {
      "kind": "RUN",
      "run": {
        "span": {
          "start": 1658,
          "end": 1661
        }
      },
      "options": [
        {
          "flag_start": 1662,
          "name": {
            "span": {
              "start": 1664,
              "end": 1669
            },
            "value": "mount"
          },
          "value": {
            "span": {
              "start": 1670,
              "end": 1705
            },
            "value": "type=bind,source=vendor,target=/app"
          }
        }
      ],
      "arguments": {
        "shell": {
          "span": {
            "start": 1711,
            "end": 1711
          },
          "value": ""
        }
      },
      "here_docs": [
        {
          "span": {
            "start": 1712,
            "end": 1843
          },
          "expand": true,
          "value": "  set -e\n  mkdir -p /opt/vendored/include\n  find . -name '*.proto' | tar -cf - --files-from - | tar -C /opt/vendored/include -xf -\n"
        }
      ]
    },
    {
      "kind": "FROM",
      "from": {
        "span": {
          "start": 1848,
          "end": 1852
        }
      },
      "options": [],
      "image": {
        "span": {
          "start": 1853,
          "end": 1860
        },
        "value": "scratch"
      },
      "as_": [
        {
          "span": {
            "start": 1861,
            "end": 1863
          }
        },
        {
          "span": {
            "start": 1864,
            "end": 1872
          },
          "value": "protobuf"
        }
      ]
    },
    {
      "kind": "COPY",
      "copy": {
        "span": {
          "start": 1873,
          "end": 1877
        }
      },
      "options": [
        {
          "flag_start": 1878,
          "name": {
            "span": {
              "start": 1880,
              "end": 1884
            },
            "value": "link"
          },
          "value": null
        },
        {
          "flag_start": 1885,
          "name": {
            "span": {
              "start": 1887,
              "end": 1891
            },
            "value": "from"
          },
          "value": {
            "span": {
              "start": 1892,
              "end": 1898
            },
            "value": "protoc"
          }
        }
      ],
      "src": [
        {
          "path": {
            "span": {
              "start": 1899,
              "end": 1910
            },
            "value": "/opt/protoc"
          }
        }
      ],
      "dest": {
        "span": {
          "start": 1911,
          "end": 1912
        },
        "value": "/"
      }
    },
    {
      "kind": "COPY",
      "copy": {
        "span": {
          "start": 1913,
          "end": 1917
        }
      },
      "options": [
        {
          "flag_start": 1918,
          "name": {
            "span": {
              "start": 1920,
              "end": 1924
            },
            "value": "link"
          },
          "value": null
        },
        {
          "flag_start": 1925,
          "name": {
            "span": {
              "start": 1927,
              "end": 1931
            },
            "value": "from"
          },
          "value": {
            "span": {
              "start": 1932,
              "end": 1942
            },
            "value": "googleapis"
          }
        }
      ],
      "src": [
        {
          "path": {
            "span": {
              "start": 1943,
              "end": 1958
            },
            "value": "/opt/googleapis"
          }
        }
      ],
      "dest": {
        "span": {
          "start": 1959,
          "end": 1960
        },
        "value": "/"
      }
    },
    {
      "kind": "COPY",
      "copy": {
        "span": {
          "start": 1961,
          "end": 1965
        }
      },
      "options": [
        {
          "flag_start": 1966,
          "name": {
            "span": {
              "start": 1968,
              "end": 1972
            },
            "value": "link"
          },
          "value": null
        },
        {
          "flag_start": 1973,
          "name": {
            "span": {
              "start": 1975,
              "end": 1979
            },
            "value": "from"
          },
          "value": {
            "span": {
              "start": 1980,
              "end": 1990
            },
            "value": "vtprotobuf"
          }
        }
      ],
      "src": [
        {
          "path": {
            "span": {
              "start": 1991,
              "end": 2006
            },
            "value": "/opt/vtprotobuf"
          }
        }
      ],
      "dest": {
        "span": {
          "start": 2007,
          "end": 2008
        },
        "value": "/"
      }
    },
    {
      "kind": "COPY",
      "copy": {
        "span": {
          "start": 2009,
          "end": 2013
        }
      },
      "options": [
        {
          "flag_start": 2014,
          "name": {
            "span": {
              "start": 2016,
              "end": 2020
            },
            "value": "link"
          },
          "value": null
        },
        {
          "flag_start": 2021,
          "name": {
            "span": {
              "start": 2023,
              "end": 2027
            },
            "value": "from"
          },
          "value": {
            "span": {
              "start": 2028,
              "end": 2036
            },
            "value": "vendored"
          }
        }
      ],
      "src": [
        {
          "path": {
            "span": {
              "start": 2037,
              "end": 2050
            },
            "value": "/opt/vendored"
          }
        }
      ],
      "dest": {
        "span": {
          "start": 2051,
          "end": 2052
        },
        "value": "/"
      }
    },
    {
      "kind": "FROM",
      "from": {
        "span": {
          "start": 2054,
          "end": 2058
        }
      },
      "options": [],
      "image": {
        "span": {
          "start": 2059,
          "end": 2071
        },
        "value": "gobuild-base"
      },
      "as_": [
        {
          "span": {
            "start": 2072,
            "end": 2074
          }
        },
        {
          "span": {
            "start": 2075,
            "end": 2080
          },
          "value": "tools"
        }
      ]
    },
    {
      "kind": "RUN",
      "run": {
        "span": {
          "start": 2081,
          "end": 2084
        }
      },
      "options": [
        {
          "flag_start": 2085,
          "name": {
            "span": {
              "start": 2087,
              "end": 2092
            },
            "value": "mount"
          },
          "value": {
            "span": {
              "start": 2093,
              "end": 2135
            },
            "value": "type=bind,source=go.mod,target=/app/go.mod"
          }
        },
        {
          "flag_start": 2142,
          "name": {
            "span": {
              "start": 2144,
              "end": 2149
            },
            "value": "mount"
          },
          "value": {
            "span": {
              "start": 2150,
              "end": 2192
            },
            "value": "type=bind,source=go.sum,target=/app/go.sum"
          }
        },
        {
          "flag_start": 2199,
          "name": {
            "span": {
              "start": 2201,
              "end": 2206
            },
            "value": "mount"
          },
          "value": {
            "span": {
              "start": 2207,
              "end": 2237
            },
            "value": "type=cache,target=/root/.cache"
          }
        },
        {
          "flag_start": 2244,
          "name": {
            "span": {
              "start": 2246,
              "end": 2251
            },
            "value": "mount"
          },
          "value": {
            "span": {
              "start": 2252,
              "end": 2281
            },
            "value": "type=cache,target=/go/pkg/mod"
          }
        }
      ],
      "arguments": {
        "shell": {
          "span": {
            "start": 2286,
            "end": 2470
          },
          "value": "go install tool \\\n    github.com/planetscale/vtprotobuf/cmd/protoc-gen-go-vtproto \\\n    google.golang.org/grpc/cmd/protoc-gen-go-grpc \\\n    google.golang.org/protobuf/cmd/protoc-gen-go"
        }
      },
      "here_docs": []
    },
    {
      "kind": "COPY",
      "copy": {
        "span": {
          "start": 2471,
          "end": 2475
        }
      },
      "options": [
        {
          "flag_start": 2476,
          "name": {
            "span": {
              "start": 2478,
              "end": 2482
            },
            "value": "link"
          },
          "value": null
        },
        {
          "flag_start": 2483,
          "name": {
            "span": {
              "start": 2485,
              "end": 2489
            },
            "value": "from"
          },
          "value": {
            "span": {
              "start": 2490,
              "end": 2498
            },
            "value": "protobuf"
          }
        }
      ],
      "src": [
        {
          "path": {
            "span": {
              "start": 2499,
              "end": 2500
            },
            "value": "/"
          }
        }
      ],
      "dest": {
        "span": {
          "start": 2501,
          "end": 2511
        },
        "value": "/usr/local"
      }
    },
    {
      "kind": "FROM",
      "from": {
        "span": {
          "start": 2513,
          "end": 2517
        }
      },
      "options": [],
      "image": {
        "span": {
          "start": 2518,
          "end": 2523
        },
        "value": "tools"
      },
      "as_": [
        {
          "span": {
            "start": 2524,
            "end": 2526
          }
        },
        {
          "span": {
            "start": 2527,
            "end": 2536
          },
          "value": "generated"
        }
      ]
    },
    {
      "kind": "RUN",
      "run": {
        "span": {
          "start": 2537,
          "end": 2540
        }
      },
      "options": [
        {
          "flag_start": 2541,
          "name": {
            "span": {
              "start": 2543,
              "end": 2548
            },
            "value": "mount"
          },
          "value": {
            "span": {
              "start": 2549,
              "end": 2590
            },
            "value": "type=bind,target=github.com/moby/buildkit"
          }
        }
      ],
      "arguments": {
        "shell": {
          "span": {
            "start": 2596,
            "end": 2596
          },
          "value": ""
        }
      },
      "here_docs": [
        {
          "span": {
            "start": 2597,
            "end": 2872
          },
          "expand": true,
          "value": "  set -ex\n  mkdir /out\n  find github.com/moby/buildkit -name '*.proto' -o -name vendor -prune -false | xargs \\\n    protoc --go_out=/out --go-grpc_out=require_unimplemented_servers=false:/out \\\n           --go-vtproto_out=features=marshal+unmarshal+size+equal+pool+clone:/out\n"
        }
      ]
    },
    {
      "kind": "FROM",
      "from": {
        "span": {
          "start": 2877,
          "end": 2881
        }
      },
      "options": [],
      "image": {
        "span": {
          "start": 2882,
          "end": 2889
        },
        "value": "scratch"
      },
      "as_": [
        {
          "span": {
            "start": 2890,
            "end": 2892
          }
        },
        {
          "span": {
            "start": 2893,
            "end": 2899
          },
          "value": "update"
        }
      ]
    },
    {
      "kind": "COPY",
      "copy": {
        "span": {
          "start": 2900,
          "end": 2904
        }
      },
      "options": [
        {
          "flag_start": 2905,
          "name": {
            "span": {
              "start": 2907,
              "end": 2911
            },
            "value": "from"
          },
          "value": {
            "span": {
              "start": 2912,
              "end": 2921
            },
            "value": "generated"
          }
        }
      ],
      "src": [
        {
          "path": {
            "span": {
              "start": 2922,
              "end": 2951
            },
            "value": "/out/github.com/moby/buildkit"
          }
        }
      ],
      "dest": {
        "span": {
          "start": 2952,
          "end": 2953
        },
        "value": "/"
      }
    },
    {
      "kind": "FROM",
      "from": {
        "span": {
          "start": 2955,
          "end": 2959
        }
      },
      "options": [],
      "image": {
        "span": {
          "start": 2960,
          "end": 2972
        },
        "value": "gobuild-base"
      },
      "as_": [
        {
          "span": {
            "start": 2973,
            "end": 2975
          }
        },
        {
          "span": {
            "start": 2976,
            "end": 2984
          },
          "value": "validate"
        }
      ]
    },
    {
      "kind": "RUN",
      "run": {
        "span": {
          "start": 2985,
          "end": 2988
        }
      },
      "options": [
        {
          "flag_start": 2989,
          "name": {
            "span": {
              "start": 2991,
              "end": 2996
            },
            "value": "mount"
          },
          "value": {
            "span": {
              "start": 2997,
              "end": 3018
            },
            "value": "type=bind,target=.,rw"
          }
        },
        {
          "flag_start": 3025,
          "name": {
            "span": {
              "start": 3027,
              "end": 3032
            },
            "value": "mount"
          },
          "value": {
            "span": {
              "start": 3033,
              "end": 3078
            },
            "value": "type=bind,from=update,target=/generated-files"
          }
        }
      ],
      "arguments": {
        "shell": {
          "span": {
            "start": 3084,
            "end": 3084
          },
          "value": ""
        }
      },
      "here_docs": [
        {
          "span": {
            "start": 3085,
            "end": 3407
          },
          "expand": true,
          "value": "  set -e\n  git add -A\n  if [ \"$(ls -A /generated-files)\" ]; then\n    cp -rf /generated-files/* .\n  fi\n  diff=$(git status --porcelain -- ':!vendor' '**/*.pb.go')\n  if [ -n \"$diff\" ]; then\n    echo >&2 'ERROR: The result of \"go generate\" differs. Please update with \"make generated-files\"'\n    echo \"$diff\"\n    exit 1\n  fi\n"
        }
      ]
    }
  ]
}